<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ytify - 下載影片</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'VT323', monospace;
            background: #0a1628;
            background-image:
                linear-gradient(rgba(50, 80, 120, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(50, 80, 120, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            min-height: 100vh;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .page-wrapper {
            width: 100%;
            max-width: 800px;
            padding: 0 20px;
        }

        .top-bar {
            background: linear-gradient(180deg, #4a6a4a 0%, #3d5a3d 50%, #2d4a2d 100%);
            border: 3px solid #2a3a2a;
            border-radius: 8px;
            margin: 20px 0;
            width: 100%;
            max-width: 700px;
            display: flex;
            align-items: center;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(255,255,255,0.2), 0 4px 8px rgba(0,0,0,0.5);
        }

        .top-bar-logo {
            background: linear-gradient(180deg, #5a8a5a, #4a7a4a);
            padding: 12px 20px;
            border-right: 3px solid #2a3a2a;
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 0 #2a3a2a;
            text-decoration: none;
        }

        .top-bar-logo:hover { background: linear-gradient(180deg, #6a9a6a, #5a8a5a); }

        .top-bar-title {
            flex: 1;
            padding: 12px 20px;
            font-size: 24px;
            color: #fff;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.5);
            background: linear-gradient(90deg, rgba(139, 90, 43, 0.6), transparent);
        }

        .nav-links { display: flex; gap: 5px; padding-right: 10px; }
        .nav-links a {
            padding: 8px 15px;
            color: #aaa;
            text-decoration: none;
            font-size: 18px;
            border-radius: 4px;
        }
        .nav-links a:hover, .nav-links a.active {
            color: #fff;
            background: rgba(255,140,66,0.3);
        }

        .console-frame {
            background: linear-gradient(180deg, #5a7a5a 0%, #4a6a4a 20%, #3d5a3d 80%, #2d4a2d 100%);
            border: 4px solid #2a3a2a;
            border-radius: 20px;
            width: 100%;
            max-width: 700px;
            margin: 20px 0;
            padding: 20px;
            box-shadow: inset 0 4px 8px rgba(255,255,255,0.1), 0 10px 30px rgba(0,0,0,0.5);
        }

        .screen {
            background: linear-gradient(180deg, #0a1a2a 0%, #0d2035 50%, #102540 100%);
            border: 4px solid #1a2a3a;
            border-radius: 12px;
            padding: 25px;
            min-height: 400px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }

        .prompt-label {
            font-size: 24px;
            color: #ff8c42;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255,140,66,0.5);
            text-align: center;
        }

        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }

        .url-input {
            flex: 1;
            padding: 15px;
            background: rgba(0,0,0,0.4);
            border: 2px solid #3a5a7a;
            border-radius: 8px;
            color: #7ac;
            font-family: 'VT323', monospace;
            font-size: 18px;
            outline: none;
        }
        .url-input:focus { border-color: #ff8c42; box-shadow: 0 0 10px rgba(255,140,66,0.3); }
        .url-input::placeholder { color: #4a6a8a; }

        .fetch-btn {
            padding: 15px 25px;
            background: linear-gradient(180deg, #ff8c42 0%, #e67a30 100%);
            border: 3px solid #c66820;
            border-radius: 8px;
            color: #fff;
            font-family: 'VT323', monospace;
            font-size: 20px;
            cursor: pointer;
        }
        .fetch-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255,140,66,0.4); }
        .fetch-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .video-info { display: none; margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.3); border: 2px solid #3a5a7a; border-radius: 10px; }
        .video-info.show { display: block; }

        .video-header { display: flex; gap: 15px; margin-bottom: 15px; }
        .video-thumb { width: 160px; height: 90px; border-radius: 6px; object-fit: cover; background: #1a2a3a; border: 2px solid #3a5a7a; }
        .video-meta { flex: 1; }
        .video-title { font-size: 18px; color: #fff; margin-bottom: 8px; line-height: 1.3; }
        .video-channel { font-size: 16px; color: #7ac; }
        .video-duration { font-size: 14px; color: #4a6a8a; }

        .format-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; }

        .format-btn {
            padding: 12px;
            background: rgba(255,140,66,0.2);
            border: 2px solid #c66820;
            border-radius: 8px;
            color: #ff8c42;
            font-family: 'VT323', monospace;
            font-size: 18px;
            cursor: pointer;
            text-align: center;
        }
        .format-btn:hover { background: rgba(255,140,66,0.4); transform: translateY(-2px); }
        .format-btn.audio { border-color: #4caf50; color: #4caf50; background: rgba(76,175,80,0.2); }
        .format-btn.audio:hover { background: rgba(76,175,80,0.4); }
        .format-btn .label { display: block; font-weight: bold; }
        .format-btn .desc { font-size: 14px; opacity: 0.7; }

        .progress-area { display: none; margin-top: 20px; }
        .progress-area.show { display: block; }
        .progress-status { font-size: 18px; color: #7ac; margin-bottom: 10px; text-align: center; }
        .progress-bar-wrap { height: 20px; background: rgba(0,0,0,0.4); border: 2px solid #3a5a7a; border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ff8c42, #ffa060); transition: width 0.3s; }
        .progress-bar.loading { width: 30%; animation: loading 1.5s ease-in-out infinite; }
        @keyframes loading { 0%, 100% { width: 20%; margin-left: 0; } 50% { width: 40%; margin-left: 60%; } }
        .progress-bar.done { width: 100%; background: linear-gradient(90deg, #4caf50, #66bb6a); }
        .progress-bar.error { width: 100%; background: linear-gradient(90deg, #f44336, #e57373); }
        .progress-bar.cancelled { width: 100%; background: linear-gradient(90deg, #ff9800, #ffc107); }

        .cancel-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: linear-gradient(180deg, #f44336, #d32f2f);
            border: 2px solid #b71c1c;
            border-radius: 6px;
            color: #fff;
            font-family: 'VT323', monospace;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        .cancel-btn:hover { background: linear-gradient(180deg, #e57373, #f44336); }
        .cancel-btn:disabled { background: #666; border-color: #444; cursor: not-allowed; }

        .error-msg { display: none; margin-top: 15px; padding: 12px; background: rgba(244,67,54,0.2); border: 2px solid #f44336; border-radius: 8px; color: #ff6b6b; font-size: 16px; text-align: center; }
        .error-msg.show { display: block; }

        .bottom-arrow { text-align: center; margin-top: -10px; position: relative; z-index: 10; width: 100%; }
        .arrow-down { width: 50px; height: 40px; background: #ff6b35; clip-path: polygon(50% 100%, 0% 0%, 100% 0%); margin: 0 auto; }

        footer { text-align: center; padding: 30px; color: #4a6a8a; font-size: 18px; width: 100%; }
        footer a { color: #7ac; text-decoration: none; }

        @media (max-width: 600px) {
            .top-bar { margin: 10px; flex-wrap: wrap; }
            .nav-links { width: 100%; justify-content: center; padding: 10px; border-top: 2px solid #2a3a2a; }
            .input-group { flex-direction: column; }
            .video-header { flex-direction: column; }
            .video-thumb { width: 100%; height: auto; aspect-ratio: 16/9; }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="/home" class="top-bar-logo">ytify</a>
        <div class="top-bar-title">下載影片</div>
        <nav class="nav-links">
            <a href="/home">首頁</a>
            <a href="/download" class="active">下載</a>
            <a href="/playlist">清單</a>
            <a href="/history">歷史</a>
            <a href="/files">檔案</a>
        </nav>
    </div>

    <div class="console-frame">
        <div class="screen">
            <div class="prompt-label">貼上 YouTube 網址</div>
            <div class="input-group">
                <input type="text" class="url-input" id="urlInput" placeholder="https://www.youtube.com/watch?v=..." autocomplete="off">
                <button class="fetch-btn" id="fetchBtn">解析</button>
            </div>
            <div class="error-msg" id="errorMsg"></div>
            <div class="video-info" id="videoInfo">
                <div class="video-header">
                    <img class="video-thumb" id="videoThumb" src="" alt="">
                    <div class="video-meta">
                        <div class="video-title" id="videoTitle"></div>
                        <div class="video-channel" id="videoChannel"></div>
                        <div class="video-duration" id="videoDuration"></div>
                    </div>
                </div>
                <div class="format-options">
                    <button class="format-btn" data-format="best" data-audio="false"><span class="label">最佳畫質</span><span class="desc">自動選擇</span></button>
                    <button class="format-btn" data-format="1080p" data-audio="false"><span class="label">1080p</span><span class="desc">Full HD</span></button>
                    <button class="format-btn" data-format="720p" data-audio="false"><span class="label">720p</span><span class="desc">HD</span></button>
                    <button class="format-btn" data-format="480p" data-audio="false"><span class="label">480p</span><span class="desc">SD</span></button>
                    <button class="format-btn audio" data-format="best" data-audio="true"><span class="label">僅音訊</span><span class="desc">AAC</span></button>
                </div>
            </div>
            <div class="progress-area" id="progressArea">
                <div class="progress-status" id="progressStatus">準備中...</div>
                <div class="progress-bar-wrap"><div class="progress-bar" id="progressBar"></div></div>
                <button class="cancel-btn" id="cancelBtn" style="display: none;">取消下載</button>
            </div>
        </div>
    </div>

    <div class="bottom-arrow"><div class="arrow-down"></div></div>
    <footer>Powered by UPPER</footer>

    <script>
        const API_BASE = window.location.origin;
        const WS_BASE = API_BASE.replace('http', 'ws');
        const urlInput = document.getElementById('urlInput');
        const fetchBtn = document.getElementById('fetchBtn');
        const errorMsg = document.getElementById('errorMsg');
        const videoInfo = document.getElementById('videoInfo');
        const progressArea = document.getElementById('progressArea');
        const progressStatus = document.getElementById('progressStatus');
        const progressBar = document.getElementById('progressBar');
        let currentUrl = '';
        let ws = null;
        let currentTaskId = null;
        const cancelBtn = document.getElementById('cancelBtn');

        fetchBtn.addEventListener('click', async () => {
            const url = urlInput.value.trim();
            if (!url) { showError('請輸入 YouTube 影片網址'); return; }
            if (!url.includes('youtube.com') && !url.includes('youtu.be')) { showError('請輸入有效的 YouTube 網址'); return; }

            hideError();
            videoInfo.classList.remove('show');
            fetchBtn.disabled = true;
            fetchBtn.textContent = '解析中...';

            try {
                const res = await fetch(`${API_BASE}/api/info`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url }) });
                const data = await res.json();
                if (data.error || data.detail) throw new Error(data.error || data.detail);
                currentUrl = url;
                showVideoInfo(data);
            } catch (e) { showError(e.message || '解析失敗'); }
            finally { fetchBtn.disabled = false; fetchBtn.textContent = '解析'; }
        });

        urlInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') fetchBtn.click(); });

        function showVideoInfo(info) {
            document.getElementById('videoThumb').src = info.thumbnail || '';
            document.getElementById('videoTitle').textContent = info.title || '未知標題';
            document.getElementById('videoChannel').textContent = info.channel || '';
            document.getElementById('videoDuration').textContent = formatDuration(info.duration);
            videoInfo.classList.add('show');
        }

        function formatDuration(s) {
            if (!s) return '';
            const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
            return h > 0 ? `${h}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}` : `${m}:${sec.toString().padStart(2,'0')}`;
        }

        document.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', () => startDownload(btn.dataset.format, btn.dataset.audio === 'true'));
        });

        async function startDownload(format, audioOnly) {
            if (!currentUrl) { showError('請先解析影片'); return; }
            hideError();
            progressArea.classList.add('show');
            progressBar.className = 'progress-bar loading';
            progressStatus.textContent = '開始下載...';

            try {
                const res = await fetch(`${API_BASE}/api/download`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: currentUrl, format, audio_only: audioOnly }) });
                const data = await res.json();
                if (data.error || data.detail) throw new Error(data.error || data.detail);

                // 保存任務 ID 並顯示取消按鈕
                currentTaskId = data.task_id;
                cancelBtn.style.display = 'block';

                // 優先使用 WebSocket，失敗時回退到輪詢
                try {
                    connectWebSocket(data.task_id);
                } catch (e) {
                    console.log('[WS] 無法使用 WebSocket，使用輪詢');
                    pollStatus(data.task_id);
                }
            } catch (e) { showDownloadError(e.message || '下載失敗'); }
        }

        // 取消下載
        cancelBtn.addEventListener('click', async () => {
            if (!currentTaskId) return;

            cancelBtn.disabled = true;
            cancelBtn.textContent = '取消中...';

            try {
                const res = await fetch(`${API_BASE}/api/task/${currentTaskId}`, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    progressBar.className = 'progress-bar cancelled';
                    progressStatus.textContent = '已取消';
                    if (ws) { ws.close(); ws = null; }
                    setTimeout(() => {
                        progressArea.classList.remove('show');
                        progressBar.className = 'progress-bar';
                        progressBar.style.width = '0%';
                        cancelBtn.style.display = 'none';
                        cancelBtn.disabled = false;
                        cancelBtn.textContent = '取消下載';
                        currentTaskId = null;
                    }, 2000);
                } else {
                    cancelBtn.textContent = data.error || '取消失敗';
                    setTimeout(() => {
                        cancelBtn.disabled = false;
                        cancelBtn.textContent = '取消下載';
                    }, 2000);
                }
            } catch (e) {
                cancelBtn.textContent = '取消失敗';
                setTimeout(() => {
                    cancelBtn.disabled = false;
                    cancelBtn.textContent = '取消下載';
                }, 2000);
            }
        });

        function connectWebSocket(taskId) {
            // 關閉現有連線
            if (ws) {
                ws.close();
                ws = null;
            }

            const wsUrl = `${WS_BASE}/api/ws/progress/${taskId}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('[WS] 已連線:', taskId);
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data === 'ping') {
                        ws.send('pong');
                        return;
                    }
                    handleProgressUpdate(data);
                } catch (e) {
                    if (event.data === 'ping') {
                        ws.send('pong');
                    }
                }
            };

            ws.onerror = (error) => {
                console.log('[WS] 錯誤，回退到輪詢');
                ws = null;
                pollStatus(taskId);
            };

            ws.onclose = () => {
                console.log('[WS] 連線關閉');
                ws = null;
            };
        }

        function handleProgressUpdate(data) {
            const status = data.status;

            if (status === 'queued') {
                progressBar.className = 'progress-bar loading';
                progressStatus.textContent = data.message || '排隊中...';
            }
            else if (status === 'downloading') {
                progressBar.className = 'progress-bar';
                progressBar.style.width = (data.progress || 0) + '%';
                const speed = data.speed ? ` (${data.speed})` : '';
                progressStatus.textContent = `下載中 ${Math.round(data.progress || 0)}%${speed}`;
            }
            else if (status === 'processing') {
                progressBar.className = 'progress-bar loading';
                progressStatus.textContent = '處理中...';
            }
            else if (status === 'retrying') {
                progressBar.className = 'progress-bar loading';
                const retryMsg = data.message || '重試中...';
                const retryCount = data.retry_count ? ` (${data.retry_count})` : '';
                progressStatus.textContent = `${retryMsg}${retryCount}`;
            }
            else if (status === 'completed') {
                progressBar.className = 'progress-bar done';
                progressStatus.textContent = '下載完成！';
                cancelBtn.style.display = 'none';
                currentTaskId = null;
                if (data.filename) {
                    const a = document.createElement('a');
                    a.href = `${API_BASE}/api/download-file/${encodeURIComponent(data.filename)}`;
                    a.download = data.filename;
                    a.click();
                }
                setTimeout(() => {
                    progressArea.classList.remove('show');
                    progressBar.className = 'progress-bar';
                    progressBar.style.width = '0%';
                }, 3000);
                if (ws) { ws.close(); ws = null; }
            }
            else if (status === 'cancelled') {
                progressBar.className = 'progress-bar cancelled';
                progressStatus.textContent = '已取消';
                cancelBtn.style.display = 'none';
                currentTaskId = null;
                setTimeout(() => {
                    progressArea.classList.remove('show');
                    progressBar.className = 'progress-bar';
                    progressBar.style.width = '0%';
                }, 2000);
                if (ws) { ws.close(); ws = null; }
            }
            else if (status === 'failed') {
                cancelBtn.style.display = 'none';
                currentTaskId = null;
                showDownloadError(data.error || '下載失敗');
                if (ws) { ws.close(); ws = null; }
            }
        }

        async function pollStatus(taskId) {
            const startTime = Date.now();
            const poll = async () => {
                // 如果已經有 WebSocket 連線，停止輪詢
                if (ws) return;

                if (Date.now() - startTime > 600000) { showDownloadError('下載超時'); return; }
                try {
                    const res = await fetch(`${API_BASE}/api/status/${taskId}`);
                    const status = await res.json();
                    handleProgressUpdate(status);

                    // 繼續輪詢非終結狀態
                    if (!['completed', 'failed'].includes(status.status)) {
                        setTimeout(poll, 1500);
                    }
                } catch (e) { setTimeout(poll, 3000); }
            };
            poll();
        }

        function showError(msg) { errorMsg.textContent = msg; errorMsg.classList.add('show'); }
        function hideError() { errorMsg.classList.remove('show'); }
        function showDownloadError(msg) {
            progressBar.className = 'progress-bar error';
            progressStatus.textContent = '錯誤：' + msg;
            setTimeout(() => { progressArea.classList.remove('show'); progressBar.className = 'progress-bar'; progressBar.style.width = '0%'; }, 5000);
        }
    </script>
</body>
</html>
