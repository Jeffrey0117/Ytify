# ytify 效能討論：並行下載與加速優化

## 問題一：同時下載多個影片

### 目前狀況

**結論：可以，但有限制**

目前 ytify 使用佇列系統 (Queue) 處理下載任務：

```
任務 A ──┐
任務 B ──┼──> 佇列 ──> 依序執行
任務 C ──┘
```

#### 現有機制
- `services/queue.py` - 下載佇列管理
- 預設 **1 個 worker**（同時只處理 1 個下載）
- 新任務會排隊等待

#### 為什麼這樣設計？
1. **避免 YouTube 封鎖** - 同時多個連線容易觸發 rate limit
2. **頻寬管理** - 避免多任務搶頻寬導致全部變慢
3. **系統穩定** - 減少記憶體和 CPU 壓力

### 改進方案

#### 方案 A：增加並行 Worker 數量

```python
# services/queue.py
class DownloadQueue:
    def __init__(self, max_workers: int = 3):  # 改為 3 個並行
        self.max_workers = max_workers
```

**優點：**
- 實作簡單
- 可同時下載 2-3 個影片

**缺點：**
- 更容易被 YouTube 限速
- 頻寬分散

**建議值：** 2-3 個 worker（不建議超過 3）

#### 方案 B：智能佇列調度

根據影片大小、格式自動決定是否並行：
- 小檔案（< 100MB）：可並行
- 大檔案（> 500MB）：單獨處理
- 音訊檔：可並行多個

#### 方案 C：用戶可配置

讓用戶在設定中選擇：
```
並行下載數：[1] [2] [3]
```

---

## 問題二：加速下載

### 目前瓶頸分析

1. **YouTube 限速** - 最主要瓶頸
2. **單線程下載** - yt-dlp 預設單線程
3. **網路延遲** - 本地到 YouTube 伺服器的延遲

### 加速方案

#### 方案 1：啟用 yt-dlp 多線程（推薦）

yt-dlp 支援使用 aria2c 進行多線程下載：

```python
# services/downloader.py
ydl_opts = {
    'external_downloader': 'aria2c',
    'external_downloader_args': [
        '-x', '16',      # 16 個連線
        '-k', '1M',      # 每塊 1MB
        '-s', '16',      # 16 個分割
    ],
}
```

**效果：**
- 單一影片下載速度可提升 2-5 倍
- 需要安裝 aria2c

**缺點：**
- 需額外安裝 aria2c
- 更容易觸發 YouTube 限速

#### 方案 2：使用 Cookies 繞過限速（推薦）

已登入的 YouTube 帳號限速較寬鬆：

```python
ydl_opts = {
    'cookiefile': './cookies.txt',  # 已實作
}
```

**目前狀態：** 已支援，需要用戶自行匯出 cookies

#### 方案 3：代理池輪換（已實作）

透過多個代理 IP 分散請求：

```python
# 已有實作
proxy_pool_api = "http://localhost:5010/get"
```

**效果：** 避免單一 IP 被限速

#### 方案 4：格式預選優化

避免下載後再轉檔：

```python
# 直接下載 mp4，不需 merge
'format': 'best[ext=mp4]',
```

**效果：** 省去 ffmpeg 轉檔時間

#### 方案 5：快取影片資訊

```python
# 快取 /api/info 結果，避免重複請求
video_info_cache = TTLCache(maxsize=100, ttl=3600)
```

### 速度對比預估

| 方案 | 預估提升 | 實作難度 | 風險 |
|------|---------|---------|------|
| 多線程 (aria2c) | 2-5x | 中 | 可能被封鎖 |
| Cookies | 1.5-2x | 低 | 低 |
| 代理池 | 1-2x | 已實作 | 中 |
| 格式優化 | 1.2x | 低 | 低 |
| 並行下載 | N 倍 (N=worker數) | 低 | 中 |

---

## 實作優先級建議

### 階段 1（低風險，快速見效）
1. ✅ Cookies 支援 - 已實作
2. 🔲 格式預選優化
3. 🔲 增加並行 worker 到 2-3

### 階段 2（中等風險）
4. 🔲 aria2c 多線程支援
5. 🔲 影片資訊快取

### 階段 3（需要更多資源）
6. 🔲 智能佇列調度
7. 🔲 用戶可配置並行數

---

## 結論

**短期建議：**
- 增加 worker 數量到 2-3
- 鼓勵用戶使用 cookies

**長期建議：**
- 整合 aria2c 多線程
- 實作智能調度系統

**注意事項：**
- 過度加速會導致 YouTube 封鎖 IP
- 建議保持保守設定，穩定優先
